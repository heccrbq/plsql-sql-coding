Two-Phase Commit (2PC) в Oracle Database - это протокол транзакций, который координирует и обеспечивает атомарность и непрерывность между распределенными базами данных. 
Когда операции изменения данных происходят одновременно в нескольких базах данных, 2PC гарантирует, что либо все изменения будут успешно завершены, либо никакие 
изменения не будут применены.

Протокол 2PC состоит из двух фаз. В первой фазе, называемой «голосование» (voting), координатор транзакции отправляет запрос на подтверждение (prepare) каждому 
участнику транзакции. Участники выполняют требуемые проверки и записывают свое решение (согласие или отказ) в журнал транзакций. Если все участники подтверждают 
готовность к коммиту, переходим ко второй фазе.

Во второй фазе, называемой «фиксация» (commit), координатор транзакции отправляет сообщение о коммите (commit message) всем участникам. Участники применяют изменения 
в своих базах данных и сохраняют результаты в постоянном хранилище. Затем они отправляют подтверждение (acknowledgement) координатору. Если все участники успешно 
применили изменения, транзакция считается завершенной.

Если во время голосования или фиксации происходит сбой или отказ одного из участников, протокол 2PC позволяет восстановить целостность данных. Координатор может 
повторно запросить подтверждение у оставшихся участников или откатить транзакцию, чтобы вернуть базы данных к предыдущему состоянию. Это обеспечивает консистентность 
распределенной транзакции в случае возникновения сбоев.

Протокол Two-Phase Commit является стандартным механизмом в Oracle Database и других распределенных системах управления базами данных для обеспечения надежности и 
целостности транзакций при работе с распределенными ресурсами.


select * From DBA_2PC_NEIGHBORS;
-- GLOBAL_TRAN_ID	Global database identifier in the format global_db_name.db_hex_id.local_tran_id, where db_hex_id is an eight-character hexadecimal value used 
-- to uniquely identify the database. This common transaction ID is the same on every node for a distributed transaction.
select * from dba_2pc_pending;
select * from dba_pending_transactions;
select * from v$global_transaction;


-- https://github.com/cheeyoung/sqlplus-public/wiki/gtrid




Наличие записей в представлении DBA_2PC_PENDING в Oracle Database указывает на то, что существуют незавершенные распределенные транзакции (distributed transactions) 
в базе данных. Это представление содержит информацию о транзакциях, которые находятся в процессе выполнения и требуют завершения или отката.

Когда выполняется распределенная транзакция с использованием протокола Two-Phase Commit (2PC), информация о транзакции сохраняется в системной таблице, известной как 
системная группа журналов (system global area, SGA). Записи в DBA_2PC_PENDING создаются для каждого участника транзакции, который принимает участие в 2PC протоколе.

Запись в DBA_2PC_PENDING обычно означает, что транзакция находится в состоянии, требующем подтверждения (prepare) или фиксации (commit). Это может быть из-за 
неудачного завершения первой фазы (голосования) протокола 2PC, сбоя в системе или других проблем, которые могут помешать завершению транзакции.

Администратор базы данных может использовать представление DBA_2PC_PENDING для мониторинга и анализа незавершенных распределенных транзакций. Он может определить, 
какие транзакции требуют дальнейших действий, таких как завершение или откат, и принять соответствующие меры для восстановления целостности данных и исправления 
возможных проблем.




Для узнать состояние распределенной транзакции в Oracle, вы можете выполнить следующий запрос в базе данных:

sql
SELECT local_tran_id, global_tran_id, state FROM DBA_2PC_PENDING;
Этот запрос извлекает информацию о распределенных транзакциях из представления DBA_2PC_PENDING. Результат будет содержать столбцы:

local_tran_id: Локальный идентификатор транзакции.
global_tran_id: Глобальный идентификатор транзакции.
state: Состояние транзакции.
Значение в столбце state указывает на текущее состояние распределенной транзакции. Некоторые возможные значения состояния включают:

ACTIVE: Транзакция активна и продолжается.
PREPARED: Транзакция подготовлена к фиксации (commit).
COMMITTED: Транзакция зафиксирована (committed) на всех участниках.
ROLLED BACK: Транзакция откачена (rolled back) на всех участниках.
Остальные возможные значения состояния могут указывать на проблемы или ошибки, которые требуют вмешательства администратора для исправления.

Примечание: Для выполнения этого запроса, у вас должны быть привилегии доступа к представлению DBA_2PC_PENDING.






Значение "COLLECTING" в поле "STATE" представления DBA_2PC_PENDING в Oracle указывает на то, что распределенная транзакция находится в процессе сбора информации от участников транзакции для завершения первой фазы протокола Two-Phase Commit (2PC).

Протокол Two-Phase Commit (2PC) состоит из двух фаз: фазы подготовки (PREPARE) и фазы коммита (COMMIT). Во время фазы подготовки, координатор транзакции отправляет запрос на подтверждение (prepare request) каждому участнику транзакции. Участники выполняют необходимые действия и голосуют за завершение (commit) или откат (rollback) транзакции.

Когда транзакция находится в состоянии "COLLECTING", она ещё не прошла фазу подготовки, и координатор транзакции собирает информацию об ответах от участников. Он ждет ответов от всех участников, чтобы принять решение о завершении или откате транзакции.

Транзакция может оставаться в состоянии "COLLECTING" до тех пор, пока координатор не получит ответы от всех участников или не будет достигнут таймаут. Затем, в зависимости от результатов голосования, транзакция перейдет в состояние "PREPARED" или будет откачена (rolled back).

Если транзакция находится в состоянии "COLLECTING" в течение длительного времени, возможно, есть проблемы с доступностью или связью с одним или несколькими участниками транзакции. В этом случае может потребоваться анализ и устранение таких проблем для успешного завершения распределенной транзакции.





В протоколе Two-Phase Commit (2PC) в Oracle, значение таймаута может быть получено с использованием системного представления данных (data dictionary) и выполнением SQL-запроса. Для этого можно использовать следующий запрос:

sql
SELECT VALUE FROM V$PARAMETER WHERE NAME = 'distributed_lock_timeout';
Этот запрос извлекает значение параметра distributed_lock_timeout, который определяет таймаут блокировки при выполнении распределенных транзакций в протоколе 2PC.

Обратите внимание, что для выполнения этого запроса требуются соответствующие привилегии доступа к системным представлениям данных (например, SELECT ANY DICTIONARY).

Пожалуйста, обратитесь к до



http://www.dba-oracle.com/topica/two_phase_commit.htm
http://www.dba-oracle.com/t_dba_2pc_pending.htm
https://oraclefiles.com/2019/03/04/resolving-in-doubt-transactions/
https://docs.oracle.com/en/database/oracle/oracle-database/19/admin/distributed-transactions-concepts.html#GUID-AD2C34BB-3619-486C-B9CF-CB872EF71076
https://docs.oracle.com/en/database/oracle/oracle-database/19/admin/managing-distributed-transactions.html
https://docs.oracle.com/en/database/oracle/oracle-database/19/admin/managing-distributed-transactions.html#GUID-26729889-99BC-4315-9903-AB8C171C557F
https://docs.oracle.com/cd/E13203_01/tuxedo/tux80/atmi/adtrn7.htm
