https://savvinov.com/2019/04/08/finding-the-root-cause-of-cpu-waits-using-stack-profiling/



1. Определяем какие процессы грузят БД: пользовательские или фоновые

col session_type for a14
col pct for a10 heading "PCT, %"
select session_type, sum(tm_delta_cpu_time) cpu, round(ratio_to_report(sum(tm_delta_cpu_time))over() * 100,2) pct 
from dba_hist_active_sess_history
group by session_type;


SESSION_TYPE          CPU     PCT, %
-------------- ---------- ----------
FOREGROUND     1.9149E+13      98,71
BACKGROUND     2.5098E+11       1,29

2 rows selected.

===========================================================================================================================================================

2. Какую нагрузку испытывала БД в разрезе по дню:

set pages 101
col histogram for a101
col pct for a10 heading "PCT, %"
select
    dtime, cpu_usage, pct,
    lpad('=', round(pct), '=') histogram
from (
    select 
        dtime, cpu_usage,
        round(cpu_usage/max(cpu_usage)over() * 100, 2) pct
    from (
        select 
            dtime, sum(cpu_usage) cpu_usage
        from (
            select 
                trunc(begin_interval_time) dtime, case when cpu < cpu_lag then cpu else cpu - cpu_lag end cpu_usage
            from (
                select begin_interval_time, value cpu, lag(value)over(order by begin_interval_time) cpu_lag
                from dba_hist_sysstat join dba_hist_snapshot using (snap_id) 
                where stat_name = 'CPU used by this session' /*SYSSTAT содержит в этой метрике общее количество циклов процессора, затраченных на все сессии*/ 
            )
        )
        group by dtime
    )
)
order by dtime;


DTIME                CPU_USAGE     PCT, % HISTOGRAM                                                                                            
------------------- ---------- ---------- -----------------------------------------------------------------------------------------------------
02.12.2023 00:00:00    3446149        2,4 ==                                                                                                   
03.12.2023 00:00:00   89685175      62,48 ==============================================================                                       
04.12.2023 00:00:00  143533430        100 ==================================================================================================== 
05.12.2023 00:00:00  137551576      95,83 ================================================================================================     
06.12.2023 00:00:00  142874426      99,54 ==================================================================================================== 
07.12.2023 00:00:00  139646477      97,29 =================================================================================================    
08.12.2023 00:00:00  140897372      98,16 ==================================================================================================   
09.12.2023 00:00:00  126608030      88,21 ========================================================================================             
10.12.2023 00:00:00  102373708      71,32 =======================================================================                              
11.12.2023 00:00:00  136415662      95,04 ===============================================================================================      
12.12.2023 00:00:00  134761986      93,89 ==============================================================================================       
13.12.2023 00:00:00  143488655      99,97 ==================================================================================================== 
14.12.2023 00:00:00  139389537      97,11 =================================================================================================    
15.12.2023 00:00:00  131922747      91,91 ============================================================================================         
16.12.2023 00:00:00  121973166      84,98 =====================================================================================                
17.12.2023 00:00:00  100708639      70,16 ======================================================================                               
18.12.2023 00:00:00   62342636      43,43 ===========================================                                                          

17 rows selected. 

===========================================================================================================================================================

3. Отрисовываем нагрузку на ЦПУ за конкретную дату в разрезе снепшота.
   Строим график в экселе по cpu_usage, чтобы понять где экстремумы.

set pages 101
col histogram for a101
col pct for a10 heading "PCT, %"
select
    btime, snap_id, cpu_usage, pct,
    lpad('=', round(pct), '=') histogram
from (
    select 
        btime, snap_id, cpu_usage,
        round(cpu_usage/max(cpu_usage)over() * 100, 2) pct
    from (
        select 
            btime, snap_id,
            case when cpu < cpu_lag then cpu else cpu - cpu_lag end cpu_usage
        from (
            select 
                cast(begin_interval_time as date) btime, snap_id, value cpu, lag(value)over(order by begin_interval_time) cpu_lag
            from dba_hist_sysstat join dba_hist_snapshot using (snap_id) 
            where stat_name = 'CPU used by this session' /*SYSSTAT содержит в этой метрике общее количество циклов процессора, затраченных на все сессии*/ 
                and begin_interval_time >= date'2023-12-13' and begin_interval_time < date'2023-12-14'
        )
    )
)
order by btime;


BTIME                  SNAP_ID  CPU_USAGE     PCT, % HISTOGRAM                                                                                            
------------------- ---------- ---------- ---------- -----------------------------------------------------------------------------------------------------
13.12.2023 00:00:59     124082                                                                                                                            
13.12.2023 00:30:03     124083    2029968       48,2 ================================================                                                     
13.12.2023 01:00:05     124084    2389439      56,73 =========================================================                                            
13.12.2023 01:30:08     124085    3624915      86,07 ======================================================================================               
13.12.2023 02:00:13     124086    3722695      88,39 ========================================================================================             
13.12.2023 02:30:17     124087    3553763      84,38 ====================================================================================                 
13.12.2023 03:00:19     124088    3036523       72,1 ========================================================================                             
13.12.2023 03:30:22     124089    4211752        100 ==================================================================================================== 
13.12.2023 04:00:28     124090    3656822      86,82 =======================================================================================              
13.12.2023 04:30:33     124091    2819824      66,95 ===================================================================                                  
13.12.2023 05:00:34     124092    3078623       73,1 =========================================================================                            
13.12.2023 05:30:38     124093    2468818      58,62 ===========================================================                                          
13.12.2023 06:00:39     124094    2151575      51,09 ===================================================                                                  
13.12.2023 06:30:43     124095    2551403      60,58 =============================================================                                        
13.12.2023 07:00:50     124096    2675698      63,53 ================================================================                                     
13.12.2023 07:30:54     124097    2898917      68,83 =====================================================================                                
13.12.2023 08:00:57     124098    3061744       72,7 =========================================================================                            
13.12.2023 08:30:03     124099    2645589      62,81 ===============================================================                                      
13.12.2023 09:00:10     124100    2862212      67,96 ====================================================================                                 
13.12.2023 09:30:12     124101    3094485      73,47 =========================================================================                            
13.12.2023 10:00:18     124102    3182052      75,55 ============================================================================                         
13.12.2023 10:30:24     124103    3390194      80,49 ================================================================================                     
13.12.2023 11:00:27     124104    3472489      82,45 ==================================================================================                   
13.12.2023 11:30:31     124105    3547600      84,23 ====================================================================================                 
13.12.2023 12:00:37     124106    3676552      87,29 =======================================================================================              
13.12.2023 12:30:43     124107    3057623       72,6 =========================================================================                            
13.12.2023 13:00:50     124108    2766552      65,69 ==================================================================                                   
13.12.2023 13:30:53     124109    3074559         73 =========================================================================                            
13.12.2023 14:00:56     124110    3289521       78,1 ==============================================================================                       
13.12.2023 14:30:59     124111    3033828      72,03 ========================================================================                             
13.12.2023 15:00:01     124112    2862950      67,98 ====================================================================                                 
13.12.2023 15:30:04     124113    2932688      69,63 ======================================================================                               
13.12.2023 16:00:06     124114    2923283      69,41 =====================================================================                                
13.12.2023 16:30:09     124115    2883603      68,47 ====================================================================                                 
13.12.2023 17:00:11     124116    3314603       78,7 ===============================================================================                      
13.12.2023 17:30:13     124117    2863727      67,99 ====================================================================                                 
13.12.2023 18:00:15     124118    3092587      73,43 =========================================================================                            
13.12.2023 18:30:17     124119    2732985      64,89 =================================================================                                    
13.12.2023 19:00:20     124120    3055775      72,55 =========================================================================                            
13.12.2023 19:30:22     124121    2895526      68,75 =====================================================================                                
13.12.2023 20:00:25     124122    2697398      64,04 ================================================================                                     
13.12.2023 20:30:27     124123    2467995       58,6 ===========================================================                                          
13.12.2023 21:00:29     124124    2777290      65,94 ==================================================================                                   
13.12.2023 21:30:30     124125    2499886      59,36 ===========================================================                                          
13.12.2023 22:00:32     124126    2660750      63,17 ===============================================================                                      
13.12.2023 22:30:39     124127    3657613      86,84 =======================================================================================              
13.12.2023 23:00:50     124128    3378715      80,22 ================================================================================                     
13.12.2023 23:30:00     124129    2305906      54,75 =======================================================                                              

48 rows selected. 

===========================================================================================================================================================

4. Определяем какой тип выражений съедает больше всего CPU за какой-нибудь самый ресурсоемкий день. В запросе все время описано в секундах.
   То есть за сутки с 12 до 13 числа было потрачено 419 тысяч CPU TIME

col command_name for a20
select command_type, cn.command_name, 
    round(sum(elapsed_time_delta)/1e6,2) ela , round(sum(cpu_time_delta)/1e6,2) cpu, round(sum(iowait_delta)/1e6,2) io, 
    round(sum(ccwait_delta)/1e6, 2) cc, round(sum(plsexec_time_delta)/1e6, 2) plsql, round(sum(javexec_time_delta)/1e6, 2) java
from dba_hist_sqlstat st 
    join dba_hist_snapshot sn using(snap_id) 
    join dba_hist_sqltext sql using(sql_id)
    join dba_hist_sqlcommand_name cn using(command_type)
where sn.begin_interval_time between date'2023-12-13' and date'2023-12-14'
group by command_type, cn.command_name
order by cpu desc;


COMMAND_TYPE COMMAND_NAME             ELA        CPU         IO         CC      PLSQL       JAVA
------------ ----------------- ---------- ---------- ---------- ---------- ---------- ----------
          47 PL/SQL EXECUTE    59411785,1 3106915,83 2433236,79   82473,91 7633428,29 45491771,5
           3 SELECT            1948158,36  419811,73  656584,33    1194,94  384524,39        ,06       
         170 CALL METHOD        900214,23  112175,54  520418,28     295,18  133524,51      19,53
           2 INSERT              36019,17    5040,57   24766,39      52,26      11,82          0
         189 UPSERT               3542,87      795,4      45,53      144,2       5,85          0
           7 DELETE               3727,33     598,77    2130,87      54,62          0          0
           6 UPDATE              13312,04     384,76     237,27       6,15        ,15          0
          26 LOCK TABLE             13,96       5,22          0        ,24          0          0

8 rows selected.

===========================================================================================================================================================

3. В первом приближении рассмотрим запросы, у которых есть уже хороший план, его просто надо достать из истории. 
   Сначала исправляем явное.


Во втором приближнии выбираем только запросы, у которых зашкаливает среднее значение cpu time за один запуск.
   То есть пока чиним самые долгоработающие запросы.


select sql_id, count(distinct plan_hash_value) unq_phv, count(distinct trunc(sn.begin_interval_time)) unq_days, sum(st.executions_delta) e,
    round(sum(elapsed_time_delta)/1e6,2) ela , round(sum(cpu_time_delta)/1e6,2) cpu, round(sum(iowait_delta)/1e6,2) io, 
    round(sum(ccwait_delta)/1e6, 2) cc, round(sum(plsexec_time_delta)/1e6, 2) plsql, round(sum(javexec_time_delta)/1e6, 2) java,
    round(sum(cpu_time_delta)/greatest(sum(st.executions_delta),1)/1e6/2) avg_cpu#
from dba_hist_sqlstat st 
    join dba_hist_snapshot sn using(snap_id) 
    join dba_hist_sqltext sql using(sql_id)
    join dba_hist_sqlcommand_name cn using(command_type)
where cn.command_name = 'SELECT'
--    and sn.begin_interval_time between date'2023-12-13' and date'2023-12-14'
group by sql_id
--order by cpu/greatest(e,1) desc
order by cpu desc nulls last fetch first 10 row only


SQL_ID           UNQ_PHV   UNQ_DAYS          E        ELA        CPU         IO         CC      PLSQL       JAVA   AVG_CPU#
------------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ---------- ----------
6mc71tv6p5fyy          1         16    3543069 6815998,55 2502765,51    8401,35       17,3 3273830,27          0          0
78agk7zntdkaq          1         16   10979062 1933495,59  654702,81  150860,73      87,67 1699837,03          0          0
dkfvyq80vys4w          1         17 1121247347 1434247,61   297212,4    1632,81     209,32          0          0          0
96gp81sx8gg4m          4         15   16381633 4683037,51  262132,34 4297532,14     112,45          0          0          0
6pq2srwy9dqth          2         16      10303 2025557,22  208846,71 1538469,99    6121,59          0          0         10
16k6ju2khyrg7          1         15    2337434  408390,36  158816,61      11,03 ,32                 0          0          0
0za9fv0j1vgkk          1         17     109419  330413,59  112198,01     139,89      21,73          0          0          1
bzbnu7nbkhbkp          1         13     872305  267358,61    87913,7 ,29        ,01                 0          0          0
axz7swrg58waj          1         16  143612022  730884,73   81646,57  517063,12      11,46          0          0          0
duthwsu2fkf7g          1         16    1416275  817181,07   77451,66   704941,9       1,02          0          0          0

10 rows selected.  




07n2b5jpaw6rm
07n2b5jpaw6rm
5pgk4an7fgh7q
4rs58v2kxjf5t
894m1tz8t8b5g
2rg6n022hn5sr
b5mrgbw037up5
b5mrgbw037up5
fuwp7amjy9jmq
f8hxrc98yymy7
8606spypp6g74
8606spypp6g74
5805h6y15t1jw
bvb6wsanfyvfx
3ysq55hgddyjw
3ysq55hgddyjw